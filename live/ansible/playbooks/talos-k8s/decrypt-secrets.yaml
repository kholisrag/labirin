---
- name: Decrypt Talos Kubernetes Cluster Secrets
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/main.yaml
    - vars/vault.yaml

  vars:
    output_dir: "{{ playbook_dir }}/generated"
    encrypted_dir: "{{ playbook_dir }}/secrets"

  tasks:
    # ============================================
    # Pre-flight checks
    # ============================================
    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: "0750"
      tags:
        - always

    - name: Verify encrypted directory exists
      ansible.builtin.stat:
        path: "{{ encrypted_dir }}"
      register: encrypted_dir_stat
      tags:
        - always

    - name: Fail if encrypted directory does not exist
      ansible.builtin.fail:
        msg: "Encrypted directory {{ encrypted_dir }} does not exist"
      when: not encrypted_dir_stat.stat.exists
      tags:
        - always

    # ============================================
    # Decrypt secrets
    # ============================================
    - name: Include decryption tasks
      ansible.builtin.include_tasks:
        file: tasks/decrypt.yaml
      tags:
        - decrypt

    # ============================================
    # Summary
    # ============================================
    - name: Display decrypted files location
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Decryption Complete!"
          - "========================================"
          - ""
          - "Decrypted files are available in: {{ output_dir }}"
          - ""
          - "Available files:"
          - "  - secrets.yaml"
          - "  - talosconfig"
          - "  - controlplane.yaml"
          - "  - worker.yaml"
          - ""
          - "Note: These files contain sensitive information."
          - "      Handle them with care!"
          - ""
      tags:
        - always
