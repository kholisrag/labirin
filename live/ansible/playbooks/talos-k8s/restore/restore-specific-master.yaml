---
- name: Restore Specific Talos Master Node to Existing Cluster
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yaml
    - ../vars/vault.yaml

  vars:
    output_dir: "{{ playbook_dir }}/../generated"
    secrets_file: "{{ output_dir }}/secrets.yaml"
    talosconfig_file: "{{ output_dir }}/talosconfig"
    controlplane_config_file: "{{ output_dir }}/controlplane.yaml"

    kubernetes_version: "1.34.1"
    patches_dir: "{{ playbook_dir }}/../vars/patches/{{ kubernetes_version }}"

    # Target node to restore (override via -e on command line)
    target_node_ip: ""
    target_node_vm_id: ""
    target_node_domain: ""

  tasks:
    # ============================================
    # STEP 1: Download and setup talosctl
    # ============================================
    - name: Include talosctl setup tasks
      ansible.builtin.include_tasks:
        file: ../tasks/talosctl.yaml
      tags:
        - always

    # ============================================
    # STEP 2: Pre-flight checks
    # ============================================
    - name: Validate required parameters
      ansible.builtin.assert:
        that:
          - target_node_ip is defined and target_node_ip != ""
          - target_node_vm_id is defined and target_node_vm_id != ""
          - cluster_name is defined
          - cluster_endpoint is defined
        fail_msg: |
          Required parameters missing. Please provide:
            -e target_node_ip=<IP>
            -e target_node_vm_id=<VM_ID>
            -e target_node_domain=<DOMAIN> (optional)
      tags:
        - always

    - name: Check if secrets bundle exists
      ansible.builtin.stat:
        path: "{{ secrets_file }}"
      register: secrets_stat
      tags:
        - always

    - name: Fail if secrets bundle not found
      ansible.builtin.fail:
        msg: |
          Secrets bundle not found at {{ secrets_file }}
          Please run the initial cluster setup first to generate secrets.
      when: not secrets_stat.stat.exists
      tags:
        - always

    - name: Display restore configuration
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Restoring Master Node to Existing Cluster"
          - "=========================================="
          - ""
          - "Cluster Name: {{ cluster_name }}"
          - "Cluster Endpoint: {{ cluster_endpoint }}"
          - "Target Node IP: {{ target_node_ip }}"
          - "Target Node VM ID: {{ target_node_vm_id }}"
          - "Target Node Domain: {{ target_node_domain | default('N/A') }}"
          - ""
      tags:
        - always

    # ============================================
    # STEP 2: Generate fresh controlplane config
    # ============================================
    - name: Generate fresh controlplane configuration for target node
      ansible.builtin.command: |
        {{ talosctl_bin }} gen config {{ cluster_name }} https://{{ cluster_endpoint }}:6443 \
          --kubernetes-version {{ kubernetes_version }} \
          --with-secrets {{ secrets_file }} \
          --output-dir {{ output_dir }} \
          {% if talos_factory_image_url is defined %}--install-image {{ talos_factory_image_url }} {% endif %} \
          --config-patch @{{ patches_dir }}/base-patch.yaml \
          --config-patch-control-plane @{{ patches_dir }}/controlplane-patch.yaml \
          {% if additional_sans is defined and additional_sans | length > 0 %}--additional-sans {{ additional_sans | join(',') }} {% endif %} \
          --force
      changed_when: true
      tags:
        - generate
        - config

    # ============================================
    # STEP 3: Apply configuration to target node
    # ============================================
    - name: Apply controlplane configuration to target node
      ansible.builtin.command: |
        {{ talosctl_bin }} apply-config --insecure \
          --nodes {{ target_node_ip }} \
          --file {{ controlplane_config_file }}
      register: apply_result
      until: apply_result.rc == 0
      retries: 3
      delay: 10
      changed_when: true
      tags:
        - apply

    - name: Wait for node to begin reboot
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for target node {{ target_node_vm_id }} to begin reboot..."
      tags:
        - apply
        - boot-config

    - name: Wait for QEMU Guest Agent to be available
      ansible.builtin.shell: |
        set -o pipefail
        qm guest cmd {{ target_node_vm_id }} ping
      delegate_to: "{{ pve_node }}"
      register: guest_agent_check
      until: guest_agent_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false
      tags:
        - apply
        - boot-config

    # ============================================
    # STEP 4: Configure boot settings and reboot
    # ============================================
    - name: Configure boot settings and reboot target node
      ansible.builtin.shell: |
        set -o pipefail
        qm set {{ target_node_vm_id }} --ide2 none --boot order=scsi0 && \
        sleep 3 && \
        qm reboot {{ target_node_vm_id }} || qm stop {{ target_node_vm_id }} && qm start {{ target_node_vm_id }}
      delegate_to: "{{ pve_node }}"
      changed_when: true
      failed_when: false
      tags:
        - apply
        - boot-config

    - name: Wait for node to complete reboot
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for target node {{ target_node_vm_id }} to complete reboot..."
      tags:
        - apply
        - boot-config

    - name: Verify target node is running
      ansible.builtin.shell: |
        set -o pipefail
        qm status {{ target_node_vm_id }} | grep -q running || qm start {{ target_node_vm_id }}
      delegate_to: "{{ pve_node }}"
      changed_when: false
      failed_when: false
      register: node_status_check
      retries: 5
      delay: 10
      tags:
        - apply
        - boot-config

    # ============================================
    # STEP 5: Wait for node to join cluster
    # ============================================
    - name: Wait for Talos API to become available on target node
      ansible.builtin.command: |
        {{ talosctl_bin }} -n {{ target_node_ip }} version
      register: talos_version_check
      until: talos_version_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false
      tags:
        - verify

    - name: Get node name from Talos
      ansible.builtin.shell: |
        set -o pipefail
        {{ talosctl_bin }} -n {{ target_node_ip }} get nodename -o jsonpath='{.spec.nodename}'
      register: node_name_result
      changed_when: false
      failed_when: false
      tags:
        - verify

    - name: Set node name fact
      ansible.builtin.set_fact:
        target_node_name: "{{ node_name_result.stdout | trim }}"
      when: node_name_result.rc == 0
      tags:
        - verify

    - name: Display target node name
      ansible.builtin.debug:
        msg: "Target node name: {{ target_node_name | default('unknown') }}"
      tags:
        - verify

    - name: Wait for node to join Kubernetes cluster
      ansible.builtin.command: |
        kubectl get nodes
      register: nodes_status
      until: >-
        nodes_status.rc == 0 and
        target_node_name is defined and
        target_node_name in nodes_status.stdout
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false
      tags:
        - verify

    # ============================================
    # STEP 6: Verify node status
    # ============================================
    - name: Get cluster nodes status
      ansible.builtin.command: |
        kubectl get nodes -o wide
      register: nodes_output
      changed_when: false
      tags:
        - verify

    - name: Display nodes status
      ansible.builtin.debug:
        var: nodes_output.stdout_lines
      tags:
        - verify

    - name: Check etcd cluster health
      ansible.builtin.command: |
        {{ talosctl_bin }} -n {{ target_node_ip }} etcd members
      register: etcd_members
      changed_when: false
      failed_when: false
      tags:
        - verify

    - name: Display etcd members
      ansible.builtin.debug:
        var: etcd_members.stdout_lines
      when: etcd_members.rc == 0
      tags:
        - verify

    # ============================================
    # STEP 7: Display summary
    # ============================================
    - name: Display restore summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Master Node Restore Complete!"
          - "=========================================="
          - ""
          - "Restored Node IP: {{ target_node_ip }}"
          - "Restored Node VM ID: {{ target_node_vm_id }}"
          - "Restored Node Domain: {{ target_node_domain | default('N/A') }}"
          - ""
          - "The node has been configured and should join the cluster automatically."
          - "etcd will sync with existing cluster members."
          - ""
          - "Verify with:"
          - "  kubectl get nodes"
          - "  {{ talosctl_bin }} -n {{ target_node_ip }} etcd members"
          - ""
      tags:
        - always
