---
- name: Centralized OPNsense Firewall Rules Management
  hosts: localhost
  gather_facts: false

  vars:
    ansible_python_interpreter: "{{ playbook_dir | regex_replace('(.*labirin).*', '\\1') }}/.labirin_venv/bin/python3"

  vars_files:
    - vars/main.yaml
    - vars/vault.yaml

  module_defaults:
    group/oxlorg.opnsense.all:
      firewall: "{{ opnsense_host }}"
      api_credential_file: "{{ opnsense_api_credential_file | default(omit) }}"
      api_key: "{{ opnsense_api_key | default(omit) }}"
      api_secret: "{{ opnsense_api_secret | default(omit) }}"
      ssl_verify: "{{ opnsense_ssl_verify | default(true) }}"

    oxlorg.opnsense.rule_multi:
      match_fields: "{{ opnsense_rule_match_fields | default(['description']) }}"
      reload: "{{ opnsense_reload | default(true) }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - opnsense_host is defined
          - firewall_rule_groups is defined
        fail_msg: "Required variables are missing. Please check vars/main.yaml"

    - name: Display firewall being configured
      ansible.builtin.debug:
        msg: "Configuring firewall rules on {{ opnsense_host }}"

    # Task for managing rules by logical groups
    - name: Manage firewall rules by groups
      oxlorg.opnsense.rule_multi:
        rules: "{{ item.rules }}"
        multi_control:
          fail_verify: "{{ item.fail_verify | default(true) }}"
          fail_processing: "{{ item.fail_processing | default(false) }}"
          output_info: "{{ item.output_info | default(false) }}"
          override: "{{ item.override | default(omit) }}"
          state: "{{ item.state | default(omit) }}"
          enabled: "{{ item.enabled | default(omit) }}"
      loop: "{{ firewall_rule_groups | default([]) }}"
      loop_control:
        label: "{{ item.name | default('Unnamed group') }}"
      when:
        - firewall_rule_groups is defined
        - firewall_rule_groups | length > 0

    # List existing rules for verification
    - name: List existing firewall rules
      oxlorg.opnsense.list:
        target: "rule"
      register: existing_rules
      when: opnsense_list_rules | default(false)

    - name: Display existing rules
      ansible.builtin.debug:
        var: existing_rules.data
      when:
        - opnsense_list_rules | default(false)
        - existing_rules is defined

    # DANGEROUS: Purge non-configured rules
    - name: DANGEROUS | Purge non-configured rules
      oxlorg.opnsense.rule_multi:
        rules: "{{ (firewall_rule_groups | default([]) | map(attribute='rules') | flatten) }}"
        multi_control:
          purge_all: true
          filters: "{{ opnsense_purge_filters | default(omit) }}"
      when: opnsense_purge_unmanaged | default(false)
