---
# ============================================
# Decryption tasks for Talos secrets
# ============================================
# This task file handles decrypting sensitive
# Talos configuration files from encrypted storage
# ============================================

- name: Find repository root
  ansible.builtin.command:
    cmd: git rev-parse --show-toplevel
  register: repo_root_result
  changed_when: false
  tags:
    - decrypt

- name: Set repository root fact
  ansible.builtin.set_fact:
    repo_root: "{{ repo_root_result.stdout }}"
  tags:
    - decrypt

- name: Check if encrypted secrets exist
  ansible.builtin.stat:
    path: "{{ encrypted_dir }}/{{ item }}"
  register: encrypted_files_check
  loop:
    - secrets.yaml
    - talosconfig
    - controlplane.yaml
    - worker.yaml
  tags:
    - decrypt

- name: Verify at least one encrypted file exists
  ansible.builtin.assert:
    that:
      - encrypted_files_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
    fail_msg: "No encrypted files found in {{ encrypted_dir }}"
    success_msg: "Found encrypted files to decrypt"
  tags:
    - decrypt

- name: Check if secrets bundle is encrypted
  ansible.builtin.command: |
    head -n 1 {{ encrypted_dir }}/secrets.yaml
  register: secrets_encrypted_check
  changed_when: false
  failed_when: false
  when: encrypted_files_check.results[0].stat.exists
  tags:
    - decrypt

- name: Decrypt secrets bundle with ansible-vault
  ansible.builtin.command: |
    ansible-vault decrypt --vault-password-file={{ repo_root }}/.vault_pass {{ encrypted_dir }}/secrets.yaml --output={{ output_dir }}/secrets.yaml
  when:
    - encrypted_files_check.results[0].stat.exists
    - secrets_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' in secrets_encrypted_check.stdout"
  changed_when: true
  tags:
    - decrypt

- name: Copy unencrypted secrets if not encrypted
  ansible.builtin.copy:
    src: "{{ encrypted_dir }}/secrets.yaml"
    dest: "{{ output_dir }}/secrets.yaml"
    mode: "0600"
  when:
    - encrypted_files_check.results[0].stat.exists
    - secrets_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' not in secrets_encrypted_check.stdout"
  tags:
    - decrypt

- name: Check if talosconfig is encrypted
  ansible.builtin.command: |
    head -n 1 {{ encrypted_dir }}/talosconfig
  register: talosconfig_encrypted_check
  changed_when: false
  failed_when: false
  when: encrypted_files_check.results[1].stat.exists
  tags:
    - decrypt

- name: Decrypt talosconfig with ansible-vault
  ansible.builtin.command: |
    ansible-vault decrypt --vault-password-file={{ repo_root }}/.vault_pass {{ encrypted_dir }}/talosconfig --output={{ output_dir }}/talosconfig
  when:
    - encrypted_files_check.results[1].stat.exists
    - talosconfig_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' in talosconfig_encrypted_check.stdout"
  changed_when: true
  tags:
    - decrypt

- name: Copy unencrypted talosconfig if not encrypted
  ansible.builtin.copy:
    src: "{{ encrypted_dir }}/talosconfig"
    dest: "{{ output_dir }}/talosconfig"
    mode: "0600"
  when:
    - encrypted_files_check.results[1].stat.exists
    - talosconfig_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' not in talosconfig_encrypted_check.stdout"
  tags:
    - decrypt

- name: Check if controlplane config is encrypted
  ansible.builtin.command: |
    head -n 1 {{ encrypted_dir }}/controlplane.yaml
  register: controlplane_encrypted_check
  changed_when: false
  failed_when: false
  when: encrypted_files_check.results[2].stat.exists
  tags:
    - decrypt

- name: Decrypt controlplane config with ansible-vault
  ansible.builtin.command: |
    ansible-vault decrypt --vault-password-file={{ repo_root }}/.vault_pass {{ encrypted_dir }}/controlplane.yaml --output={{ output_dir }}/controlplane.yaml
  when:
    - encrypted_files_check.results[2].stat.exists
    - controlplane_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' in controlplane_encrypted_check.stdout"
  changed_when: true
  tags:
    - decrypt

- name: Copy unencrypted controlplane config if not encrypted
  ansible.builtin.copy:
    src: "{{ encrypted_dir }}/controlplane.yaml"
    dest: "{{ output_dir }}/controlplane.yaml"
    mode: "0600"
  when:
    - encrypted_files_check.results[2].stat.exists
    - controlplane_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' not in controlplane_encrypted_check.stdout"
  tags:
    - decrypt

- name: Check if worker config is encrypted
  ansible.builtin.command: |
    head -n 1 {{ encrypted_dir }}/worker.yaml
  register: worker_encrypted_check
  changed_when: false
  failed_when: false
  when: encrypted_files_check.results[3].stat.exists
  tags:
    - decrypt

- name: Decrypt worker config with ansible-vault
  ansible.builtin.command: |
    ansible-vault decrypt --vault-password-file={{ repo_root }}/.vault_pass {{ encrypted_dir }}/worker.yaml --output={{ output_dir }}/worker.yaml
  when:
    - encrypted_files_check.results[3].stat.exists
    - worker_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' in worker_encrypted_check.stdout"
  changed_when: true
  tags:
    - decrypt

- name: Copy unencrypted worker config if not encrypted
  ansible.builtin.copy:
    src: "{{ encrypted_dir }}/worker.yaml"
    dest: "{{ output_dir }}/worker.yaml"
    mode: "0600"
  when:
    - encrypted_files_check.results[3].stat.exists
    - worker_encrypted_check.stdout is defined
    - "'$ANSIBLE_VAULT' not in worker_encrypted_check.stdout"
  tags:
    - decrypt

- name: Ensure proper permissions on decrypted files
  ansible.builtin.file:
    path: "{{ output_dir }}/{{ item }}"
    mode: "0600"
  loop:
    - secrets.yaml
    - talosconfig
    - controlplane.yaml
    - worker.yaml
  when: encrypted_files_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
  tags:
    - decrypt

- name: Display decryption status
  ansible.builtin.debug:
    msg:
      - "Decryption completed!"
      - "Decrypted files are available in: {{ output_dir }}"
      - "Files decrypted:"
      - "  - secrets.yaml"
      - "  - talosconfig"
      - "  - controlplane.yaml"
      - "  - worker.yaml"
  tags:
    - decrypt
