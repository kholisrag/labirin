---
- name: Init Talos Kubernetes Cluster
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/main.yaml
    - vars/vault.yaml

  vars:
    output_dir: "{{ playbook_dir }}/generated"
    secrets_file: "{{ output_dir }}/secrets.yaml"
    talosconfig_file: "{{ output_dir }}/talosconfig"
    controlplane_config_file: "{{ output_dir }}/controlplane.yaml"
    worker_config_file: "{{ output_dir }}/worker.yaml"
    encrypted_dir: "{{ playbook_dir }}/secrets"
    patches_dir: "{{ playbook_dir }}/vars/patches"

  tasks:
    # ============================================
    # STEP 1: Pre-flight checks and setup
    # ============================================
    - name: Create output directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0750"
      loop:
        - "{{ output_dir }}"
        - "{{ encrypted_dir }}"
      tags:
        - always

    - name: Check required variables
      ansible.builtin.assert:
        that:
          - cluster_name is defined
          - cluster_endpoint is defined
          - master_hosts is defined
          - master_hosts | length >= 1
        fail_msg: "Required variables not defined. Check vars/vault.yaml and vars/main.yaml"
      tags:
        - always

    - name: Check talosctl is installed
      ansible.builtin.command: |
        which talosctl
      register: talosctl_check
      failed_when: false
      changed_when: false
      tags:
        - always

    - name: Fail if talosctl not found
      ansible.builtin.fail:
        msg: "talosctl is not installed. Install from https://github.com/siderolabs/talos/releases"
      when: talosctl_check.rc != 0
      tags:
        - always

    - name: Check kubectl is installed
      ansible.builtin.command: |
        which kubectl
      register: kubectl_check
      failed_when: false
      changed_when: false
      tags:
        - always

    - name: Display cluster configuration
      ansible.builtin.debug:
        msg:
          - "Cluster Name: {{ cluster_name }}"
          - "Cluster Endpoint: {{ cluster_endpoint }}"
          - "Master Nodes: {{ master_hosts | length }}"
          - "Kubernetes Version: {{ kubernetes_version }}"
          - "Talos Version: {{ talos_version }}"
      tags:
        - always

    # ============================================
    # STEP 1.5: Discover worker nodes from Proxmox
    # ============================================
    - name: Get all VMs from Proxmox cluster
      ansible.builtin.command: |
        pvesh get /cluster/resources --type vm --output-format json
      register: all_vms_raw
      when: use_dynamic_worker_discovery | default(true)
      delegate_to: "{{ pve_node }}"
      changed_when: false
      tags:
        - always
        - worker-discovery

    - name: Parse VMs and filter by worker tag
      ansible.builtin.set_fact:
        worker_vms: >-
          {{
            (all_vms_raw.stdout | from_json)
            | selectattr('status', 'equalto', 'running')
            | selectattr('tags', 'defined')
            | selectattr('tags', 'search', worker_node_tag)
            | list
          }}
      when:
        - use_dynamic_worker_discovery | default(true)
        - all_vms_raw.stdout is defined
      tags:
        - always
        - worker-discovery

    - name: Get IP addresses for worker VMs
      ansible.builtin.shell: |
        pvesh get /nodes/{{ item.node }}/qemu/{{ item.vmid }}/agent/network-get-interfaces --output-format json 2>/dev/null || echo '{}'
      loop: "{{ worker_vms | default([]) }}"
      register: worker_network_info
      when:
        - use_dynamic_worker_discovery | default(true)
        - worker_vms is defined
        - worker_vms | length > 0
      delegate_to: "{{ pve_node }}"
      changed_when: false
      failed_when: false
      tags:
        - always
        - worker-discovery

    - name: Extract worker IP addresses
      ansible.builtin.set_fact:
        worker_ips_list: >-
          {{
            worker_network_info.results
            | default([])
            | selectattr('stdout', 'defined')
            | map(attribute='stdout')
            | map('from_json')
            | map(attribute='result', default=[])
            | flatten
            | selectattr('name', 'defined')
            | rejectattr('name', 'equalto', 'lo')
            | map(attribute='ip-addresses', default=[])
            | flatten
            | selectattr('ip-address-type', 'defined')
            | selectattr('ip-address-type', 'equalto', 'ipv4')
            | map(attribute='ip-address')
            | select('string')
            | list
          }}
      when:
        - use_dynamic_worker_discovery | default(true)
        - worker_network_info.results is defined
      tags:
        - always
        - worker-discovery

    - name: Convert worker IPs to structured list with VMID
      ansible.builtin.set_fact:
        worker_hosts: >
          {%- set result = [] -%}
          {%- for net_result in worker_network_info.results | default([]) -%}
            {%- if net_result.stdout is defined -%}
              {%- set net_data = net_result.stdout | from_json -%}
              {%- for iface in net_data.result | default([]) -%}
                {%- if iface.name != 'lo' -%}
                  {%- for ip_addr in iface['ip-addresses'] | default([]) -%}
                    {%- if ip_addr['ip-address-type'] == 'ipv4' -%}
                      {%- set _ = result.append({'ip': ip_addr['ip-address'], 'vm_id': net_result.item.vmid, 'node': net_result.item.node}) -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}
      when:
        - use_dynamic_worker_discovery | default(true)
        - worker_network_info.results is defined
      tags:
        - always
        - worker-discovery

    - name: Display discovered worker nodes
      ansible.builtin.debug:
        msg:
          - "Dynamic worker discovery: {{ 'Enabled' if use_dynamic_worker_discovery | default(true) else 'Disabled' }}"
          - "Worker tag: {{ worker_node_tag }}"
          - "Discovered worker nodes: {{ (worker_hosts | default([])) | length }}"
          - "Worker IPs: {{ (worker_hosts | default([])) | map(attribute='ip') | join(', ') if worker_hosts is defined else 'None' }}"
      when: use_dynamic_worker_discovery | default(true)
      tags:
        - always
        - worker-discovery

    # ============================================
    # STEP 2: Generate Talos secrets bundle
    # ============================================
    - name: Check if secrets bundle already exists
      ansible.builtin.stat:
        path: "{{ secrets_file }}"
      register: secrets_stat
      tags:
        - secrets
        - generate

    - name: Generate Talos secrets bundle
      ansible.builtin.command: |
        talosctl gen secrets -o {{ secrets_file }}
      when: not secrets_stat.stat.exists
      changed_when: true
      tags:
        - secrets
        - generate

    - name: Ensure secrets file has proper permissions
      ansible.builtin.file:
        path: "{{ secrets_file }}"
        mode: "0600"
      tags:
        - secrets
        - generate

    # ============================================
    # STEP 4: Generate machine configurations
    # ============================================
    - name: Generate base machine configurations
      ansible.builtin.command: |
        talosctl gen config {{ cluster_name }} https://{{ cluster_endpoint }}:6443 \
          --with-secrets {{ secrets_file }} \
          --output-dir {{ output_dir }} \
          {% if talos_factory_image_url is defined %}--install-image {{ talos_factory_image_url }} {% endif %} \
          --config-patch @{{ patches_dir }}/base-patch.yaml \
          --config-patch-control-plane @{{ patches_dir }}/controlplane-patch.yaml \
          --config-patch-worker @{{ patches_dir }}/worker-patch.yaml \
          {% if additional_sans is defined and additional_sans | length > 0 %}--additional-sans {{ additional_sans | join(',') }} {% endif %} \
          --force
      args:
        creates: "{{ controlplane_config_file }}"
      tags:
        - generate
        - config

    # ============================================
    # STEP 5: Apply configuration to nodes
    # ============================================
    - name: Apply controlplane configuration to master nodes
      ansible.builtin.command: |
        talosctl apply-config --insecure \
          --nodes {{ item.ip }} \
          --file {{ controlplane_config_file }}
      loop: "{{ master_hosts }}"
      register: apply_result
      until: apply_result.rc == 0
      retries: 3
      delay: 10
      changed_when: true
      tags:
        - apply

    - name: Wait between master node reboots
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for master node {{ item.vm_id }} to begin reboot..."
      loop: "{{ master_hosts }}"
      tags:
        - apply
        - boot-config

    - name: Wait for QEMU Guest Agent to be available on master nodes
      ansible.builtin.shell: |
        qm guest cmd {{ item.vm_id }} ping
      loop: "{{ master_hosts }}"
      delegate_to: "{{ pve_node }}"
      register: guest_agent_check
      until: guest_agent_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false
      tags:
        - apply
        - boot-config

    - name: Configure boot settings and reboot master nodes (one at a time)
      ansible.builtin.shell: |
        qm set {{ item.vm_id }} --ide2 none --boot order=scsi0 && \
        sleep 3 && \
        qm reboot {{ item.vm_id }} || qm stop {{ item.vm_id }} && qm start {{ item.vm_id }}
      loop: "{{ master_hosts }}"
      delegate_to: "{{ pve_node }}"
      changed_when: true
      failed_when: false
      throttle: 1
      tags:
        - apply
        - boot-config

    - name: Verify master nodes are running
      ansible.builtin.shell: |
        qm status {{ item.vm_id }} | grep -q running || qm start {{ item.vm_id }}
      loop: "{{ master_hosts }}"
      delegate_to: "{{ pve_node }}"
      changed_when: false
      failed_when: false
      register: master_status_check
      retries: 5
      delay: 10
      tags:
        - apply
        - boot-config

    - name: Apply worker configuration to worker nodes
      ansible.builtin.command: |
        talosctl apply-config --insecure \
          --nodes {{ item.ip }} \
          --file {{ worker_config_file }}
      loop: "{{ worker_hosts | default([]) }}"
      when: worker_hosts is defined and worker_hosts | length > 0
      register: apply_worker_result
      until: apply_worker_result.rc == 0
      retries: 3
      delay: 10
      changed_when: true
      tags:
        - apply

    - name: Wait between worker node reboots
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for worker node {{ item.vm_id }} to begin reboot..."
      loop: "{{ worker_hosts | default([]) }}"
      when:
        - worker_hosts is defined
        - worker_hosts | length > 0
      tags:
        - apply
        - boot-config

    - name: Wait for QEMU Guest Agent to be available on worker nodes
      ansible.builtin.shell: |
        qm guest cmd {{ item.vm_id }} ping
      loop: "{{ worker_hosts | default([]) }}"
      when:
        - worker_hosts is defined
        - worker_hosts | length > 0
        - item.vm_id is defined
      delegate_to: "{{ pve_node }}"
      register: guest_agent_check_worker
      until: guest_agent_check_worker.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false
      tags:
        - apply
        - boot-config

    - name: Configure boot settings and reboot worker nodes (one at a time)
      ansible.builtin.shell: |
        qm set {{ item.vm_id }} --ide2 none --boot order=scsi0 && \
        sleep 3 && \
        qm reboot {{ item.vm_id }} || qm stop {{ item.vm_id }} && qm start {{ item.vm_id }}
      loop: "{{ worker_hosts | default([]) }}"
      when:
        - worker_hosts is defined
        - worker_hosts | length > 0
        - item.vm_id is defined
      delegate_to: "{{ pve_node }}"
      changed_when: true
      failed_when: false
      throttle: 1
      tags:
        - apply
        - boot-config

    - name: Verify worker nodes are running
      ansible.builtin.shell: |
        qm status {{ item.vm_id }} | grep -q running || qm start {{ item.vm_id }}
      loop: "{{ worker_hosts | default([]) }}"
      when:
        - worker_hosts is defined
        - worker_hosts | length > 0
        - item.vm_id is defined
      delegate_to: "{{ pve_node }}"
      changed_when: false
      failed_when: false
      register: worker_status_check
      retries: 5
      delay: 10
      tags:
        - apply
        - boot-config

    # ============================================
    # STEP 6: Bootstrap Kubernetes cluster
    # ============================================
    - name: Merge talosconfig to default location
      ansible.builtin.command: |
        talosctl config merge {{ talosconfig_file }}
      changed_when: true
      tags:
        - bootstrap
        - kubeconfig

    - name: Configure talosctl endpoints
      ansible.builtin.command: |
        talosctl config endpoint {{ master_hosts | map(attribute='ip') | join(' ') }}
      changed_when: true
      tags:
        - bootstrap
        - kubeconfig

    - name: Bootstrap etcd on first master node
      ansible.builtin.command: |
        talosctl bootstrap --nodes {{ master_hosts[0].ip }}
      register: bootstrap_result
      retries: 3
      delay: 30
      until: bootstrap_result.rc == 0
      changed_when: true
      tags:
        - bootstrap
        - etcd

    - name: Wait for Kubernetes API to become available
      ansible.builtin.pause:
        seconds: 60
        prompt: "Waiting for Kubernetes API server to start..."
      tags:
        - bootstrap

    # ============================================
    # STEP 7: Get kubeconfig and verify cluster
    # ============================================
    - name: Get kubeconfig from cluster
      ansible.builtin.command: |
        talosctl kubeconfig --nodes {{ master_hosts[0].ip }} --force
      changed_when: true
      tags:
        - kubeconfig
        - verify

    - name: Wait for all nodes to be ready
      ansible.builtin.command: kubectl get nodes
      register: nodes_status
      until: nodes_status.stdout.find('NotReady') == -1
      retries: 30
      delay: 20
      changed_when: false
      tags:
        - verify

    - name: Display cluster nodes
      ansible.builtin.command: kubectl get nodes -o wide
      register: nodes_output
      changed_when: false
      tags:
        - verify

    - name: Show nodes status
      ansible.builtin.debug:
        var: nodes_output.stdout_lines
      tags:
        - verify

    # ============================================
    # STEP 8: Encrypt sensitive files
    # ============================================
    - name: Include encryption tasks
      ansible.builtin.include_tasks:
        file: tasks/encrypt.yaml
      tags:
        - encrypt

    # ============================================
    # STEP 9: Display summary and next steps
    # ============================================
    - name: Display cluster information
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Talos Kubernetes Cluster Initialized!"
          - "========================================"
          - ""
          - "Cluster Name: {{ cluster_name }}"
          - "Cluster Endpoint: https://{{ cluster_endpoint }}:6443"
          - "Master Nodes: {{ master_hosts | map(attribute='ip') | join(', ') }}"
          - ""
          - "Generated files location: {{ output_dir }}"
          - "Encrypted files location: {{ encrypted_dir }}"
          - ""
          - "Talosctl is configured with endpoints: {{ master_hosts | map(attribute='ip') | join(', ') }}"
          - "Kubeconfig is merged to ~/.kube/config"
          - ""
      tags:
        - always
