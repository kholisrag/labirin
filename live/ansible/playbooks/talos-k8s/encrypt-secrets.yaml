---
- name: Encrypt Talos Kubernetes Cluster Secrets
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/main.yaml
    - vars/vault.yaml

  vars:
    output_dir: "{{ playbook_dir }}/generated"
    secrets_file: "{{ output_dir }}/secrets.yaml"
    talosconfig_file: "{{ output_dir }}/talosconfig"
    controlplane_config_file: "{{ output_dir }}/controlplane.yaml"
    worker_config_file: "{{ output_dir }}/worker.yaml"
    encrypted_dir: "{{ playbook_dir }}/secrets"
    auto_encrypt: true # Force encryption when using this playbook

  tasks:
    # ============================================
    # Pre-flight checks
    # ============================================
    - name: Create encrypted directory
      ansible.builtin.file:
        path: "{{ encrypted_dir }}"
        state: directory
        mode: "0750"
      tags:
        - always

    - name: Verify generated files exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: generated_files_check
      loop:
        - "{{ secrets_file }}"
        - "{{ talosconfig_file }}"
        - "{{ controlplane_config_file }}"
        - "{{ worker_config_file }}"
      tags:
        - always

    - name: Check if any files are missing
      ansible.builtin.set_fact:
        missing_files: "{{ generated_files_check.results | rejectattr('stat.exists') | map(attribute='item') | list }}"
      tags:
        - always

    - name: Warn about missing files
      ansible.builtin.debug:
        msg:
          - "Warning: Some files are missing and will be skipped:"
          - "{{ missing_files | join(', ') }}"
      when: missing_files | length > 0
      tags:
        - always

    - name: Fail if no files to encrypt
      ansible.builtin.fail:
        msg: "No generated files found in {{ output_dir }}. Please generate them first."
      when: generated_files_check.results | selectattr('stat.exists', 'equalto', true) | list | length == 0
      tags:
        - always

    # ============================================
    # Encrypt secrets
    # ============================================
    - name: Include encryption tasks
      ansible.builtin.include_tasks:
        file: tasks/encrypt.yaml
      tags:
        - encrypt

    # ============================================
    # Summary
    # ============================================
    - name: Display encrypted files location
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Encryption Complete!"
          - "========================================"
          - ""
          - "Encrypted files are stored in: {{ encrypted_dir }}"
          - ""
          - "Encrypted files:"
          - "  - secrets.yaml"
          - "  - talosconfig"
          - "  - controlplane.yaml"
          - "  - worker.yaml"
          - ""
          - "These files can now be safely committed to version control."
          - ""
      tags:
        - always
